const socket = require('socket.io')
const moment = require('moment')
const wsUsers = module.exports = {}

/**
 * Модуль обработки событий WS
 */
module.exports.websockified = server => {

  const io = socket.listen(server)

  io.on('connection', (socket) => {
    let {name, id} = socket.handshake.query
    if (id === 'new'){
      id = socket.id;
    }
    if (wsUsers[id] === undefined){
      wsUsers[id] = []
    }
    console.log(`New user ${name} connected`);
    socket.join(id)
    socket.emit('initUserInfo', {id: id, users:wsUsers[id]})
    wsUsers[id].push(name)
    console.log(`User ${name} connected to ${id} room`);
    io.to(id).emit('newUser', {name: name})
    socket.on('newMessage', function(socket){
      if (socket.text) {
        let time = moment().format('MMMM Do YYYY, h:mm:ss a');
        io.to(id).emit('chatMessage',{...socket, name, time })
      }
    })

    socket.on('disconnect', function(){
      console.log(`${name} disconnected`);
      delete wsUsers[id]
    })

  })


}